#!/sbin/openrc-run

name="ixautomation"
description="iXSystems automation framework"

start_pre()
{
  if [ -z "$ixautomation_iface" ] ; then
    ixautomation_iface="`netstat -f inet -nrW | grep '^default' | awk '{ print $6 }'`"
  fi
  if ! ifconfig ${ixautomation_bridge} >/dev/null 2>/dev/null ; then
    if ! ifconfig | grep -q member | grep -q "${ixautomation_iface}" >/dev/null 2>/dev/null ; then
      eerror "Warning ${ixautomation_iface} is already a member of another bridge.  Please define an unused interface with ixautomation_iface in /etc/rc.conf."
    fi
  fi
}

start()
{
  ixautomation_bridge="ixautomation"
  if ! ifconfig ${ixautomation_bridge} >/dev/null 2>/dev/null ; then
    bridge=$(ifconfig bridge create)
    ifconfig ${bridge} name ${ixautomation_bridge} >/dev/null
  fi
  if ! ifconfig ${ixautomation_bridge} | grep -q "tap" >/dev/null 2>/dev/null ; then
    tap=$(ifconfig tap create)
    ifconfig ${ixautomation_bridge} addm ${tap}
  fi
  if ! ifconfig ${ixautomation_bridge} | grep -q "member: ${ixautomation_iface}" ; then
     ifconfig ${ixautomation_bridge} addm ${ixautomation_iface}
  fi
}


