#!/usr/bin/env python3.6

import os
import sys
import getpass
import getopt
sys.path.append("/usr/local/lib/ixautomation")
# Source our functions
from functions import jenkins_vm_tests, jenkins_vm_destroy_all

ixautomationconfig = "/usr/local/etc/ixautomation.conf"

loginUser = os.getlogin()
curentUser = getpass.getuser()
argument = sys.argv
app = argument[0]

if os.getuid() != 0:
    print(f"You need root privileged to run {app}")
    sys.exit(1)

UsageMSG = f"""
Usage for {app}:

Available Commands:

--run                     - Runs option givin
        vm-tests          - Start (freenas, or trueos) in a VM using vm-bhyve
        api-tests         - Start VM with Python API 1.0 tests (FreeNAS only)
        api2-tests        - Start VM with Python API 2.0 tests (FreeNAS only)
        webui-tests       - Runs FreeNAS web UI tests using webdriver

--systype                 - Use by run to see what system we need to run
        freenas           - FreeNAS to be run
        trueos            - TrueOS to be run

--ip                      - IP and network card of the machine targeted
        0.0.0.0:card or 0.0.0.0

--destroy-all-vm          - Stop all vm running, remove vm directory and iso

--keep-alive              - Keep the Bhyve alive and running
"""

# if have no argumment stop
if len(argument) == 1:
    print(UsageMSG)
    exit()

# list of argument that chould be use.
optionlist = ["run=", "systype=", "ip=", "destroy-all-vm", "keep-alive"]
systypelist = ["freenas", "trueos"]
runlist = ["vm-tests", "api-tests", "api2-tests", "webui-tests"]

# look if all the argument are there.

try:
    myopts, args = getopt.getopt(argument[1:], 'rsi', optionlist)
except getopt.GetoptError as e:
    print(str(e))
    print(UsageMSG)
    sys.exit(1)

if "--systype" not in myopts and "--run" in myopts:
    print("--run need --systype")
    print(UsageMSG)
    sys.exit(1)

keep_alive = False

for output, arg in myopts:
    if output == "--destroy-all-vm":
        jenkins_vm_destroy_all()
        sys.exit(0)
    elif output == "--keep-alive":
        keep_alive = True
    elif output == '--run':
        run = arg
    elif output == '--systype':
        systype = arg
    elif output == '--ip':
        ipnc = arg

if run not in runlist:
    print(f"{run} is not a valid --run option")
    print(UsageMSG)
    sys.exit(1)

if systype not in systypelist:
    print(f"{systype} is not a valid --systype option")
    print(UsageMSG)
    sys.exit(1)

try:
    workspace = os.environ["WORKSPACE"]
except KeyError:
    if os.path.exists(ixautomationconfig):
        ixautomationcfglist = open(ixautomationconfig, 'r').readlines()
        find_line = False
        for line in ixautomationcfglist:
            linelist = line.rstrip().split('=')
            if run == "webui-tests":
                if "WebUI" in linelist[0] and "#" not in linelist[0]:
                    workspace = linelist[1].replace('"', '').strip()
                    find_line = True
                    break
            else:
                if systype == 'freenas':
                    if "FreeNAS" in linelist[0] and "#" not in linelist[0]:
                        workspace = linelist[1].replace('"', '').strip()
                        find_line = True
                        break
                elif systype == 'trueos':
                    if "TrueOS" in linelist[0] and "#" not in linelist[0]:
                        workspace = linelist[1].replace('"', '').strip()
                        find_line = True
                        break

        if find_line is False:
            if run == "webui-tests":
                print(f"Please setup WebUI path in {ixautomationconfig}")
                sys.exit(1)
            else:
                if systype == 'freenas':
                    print(f"Please setup FreeNAS path in {ixautomationconfig}")
                    sys.exit(1)
                elif systype == 'trueos':
                    print(f"Please setup TrueOS path in {ixautomationconfig}")
                    sys.exit(1)
    else:
        print(f"Please add {ixautomationconfig}")
        sys.exit(1)

try:
    ipnc
except NameError:
    ipnc = None

if run == "vm-tests":
    jenkins_vm_tests(workspace, systype, ipnc, run, keep_alive)
elif run == "api-tests":
    jenkins_vm_tests(workspace, systype, ipnc, run, keep_alive)
elif run == "api2-tests":
    jenkins_vm_tests(workspace, systype, ipnc, run, keep_alive)
elif run == "webui-tests":
    jenkins_vm_tests(workspace, systype, ipnc, run, keep_alive)
