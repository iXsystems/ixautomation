#!/usr/bin/env python3.6

import os
import sys
import getpass
import getopt
sys.path.append("/usr/local/lib/ixautomation")
# Source our functions
from functions import start_automation, destroy_all_vm

ixautomationconfig = "/usr/local/etc/ixautomation.conf"

loginUser = os.getlogin()
curentUser = getpass.getuser()
argument = sys.argv
app = argument[0]
sys.stdout.flush()

# list of argument that should be use.
optionlist = [
    "run=",
    "systype=",
    "ip=",
    "server-ip=",
    "destroy-all-vm",
    "keep-alive"
]
sys_dict = {
    "freenas": "FreeNAS",
    "trueos": "TrueOS",
    "trueview": "TrueView"
}
systypelist = list(sys_dict.keys())
runlist = [
    "vm-tests",
    "api-tests",
    "api2-tests",
    "websocket-tests",
    "webui-tests"
]

# verify it root user
if os.getuid() != 0:
    print(f"You need root privileged to run {app}")
    sys.exit(1)

UsageMSG = f"""
Usage for {app}:

Available Commands:

--run                     - Runs the given option
          vm-tests        - Install (Freenas, TrueOS or TrueView) in a VM
                            using vm-bhyve and reboot in the installation.
          api-tests       - Start VM with REST API 1.0 tests for FreeNAS
                            or REST API tests for TrueView
          api2-tests      - Start VM with REST API 2.0 tests (FreeNAS only)
          webui-tests     - Runs FreeNAS web UI tests using WebDriver
          websocket-tests - Start VM with WebSocket tests for TrueView

--systype                 - Use by run to see what system we need to run
          freenas         - FreeNAS to be run
          trueos          - TrueOS to be run
          trueview        - TrueView to be run

--ip                      - IP and network card of the machine targeted to
                            run test against.
          0.0.0.0
          0.0.0.0:card

--server-ip               - IP of the targeted FreeNAS for TrueView
          0.0.0.0

--destroy-all-vm          - Stop all VM running, remove VM directory and ISO

--keep-alive              - Keep Bhyve VM alive and running without it VM
                            is destroy when ixautomation stop.
"""

# if have no argument stop
if len(argument) == 1:
    print(UsageMSG)
    exit()

# look if all the argument are there.
try:
    myopts, args = getopt.getopt(argument[1:], 'rsi', optionlist)
except getopt.GetoptError as e:
    print(str(e))
    print(UsageMSG)
    sys.exit(1)

if "--systype" not in myopts and "--run" in myopts:
    print("--run need --systype")
    print(UsageMSG)
    sys.exit(1)

keep_alive = False

for output, arg in myopts:
    if output == "--destroy-all-vm":
        destroy_all_vm()
        sys.exit(0)
    elif output == "--keep-alive":
        keep_alive = True
    elif output == '--run':
        run = arg
    elif output == '--systype':
        systype = arg
    elif output == '--ip':
        ipnc = arg
    elif output == '--server-ip':
        server_ip = arg

try:
    ipnc
except NameError:
    ipnc = None

try:
    server_ip
except NameError:
    server_ip = None

if run not in runlist:
    print(f"{run} is not a valid --run option")
    print(UsageMSG)
    sys.exit(1)

if systype not in systypelist:
    print(f"{systype} is not a valid --systype option")
    print(UsageMSG)
    sys.exit(1)

# look for workspace
try:
    workspace = os.environ["WORKSPACE"]
except KeyError:
    if not os.path.exists(ixautomationconfig):
        print(f"Please add {ixautomationconfig}")
        sys.exit(1)

    syscfg = "WebUI" if run == "webui-tests" else sys_dict[systype]

    # loop true ixautomation config list to find syscfg
    ixautomationcfglist = open(ixautomationconfig, 'r').readlines()
    for line in ixautomationcfglist:
        linelist = line.rstrip().split('=')
        if syscfg in linelist[0] and "#" not in linelist[0]:
            workspace = linelist[1].replace('"', '').strip()
            break
    else:
        print(f"Please setup {syscfg} path in {ixautomationconfig}")
        sys.exit(1)

sysname = sys_dict[systype]
start_automation(workspace, systype, sysname, ipnc, run, keep_alive, server_ip)
